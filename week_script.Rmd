---
title: "Priyanka's script"
output: html_document
---

# Load libraries and read in data
```{r}
library(tidyverse) # for everything else!
library(lubridate) # for dates!

# get the csv files in a named vector
participant_data <- list.files(pattern = ".csv$") %>% 
  set_names()

# read them in and put in a data frame
raw_data <- map_df(participant_data, read_csv, .id = "csv_file")

# clean it up
raw_data <- raw_data %>% 
  mutate(participant_id = str_extract(csv_file, "c\\d+")) %>% 
  select(-csv_file) %>% 
  relocate(participant_id)
```

# Clean the data
```{r}
acti_data <- raw_data %>% 
  mutate(date = date(calender_date),
         week = isoweek(date),
         weekday = wday(date, label = TRUE),
         timestamp = as.numeric(date)) %>% 
  filter(!is.na(RA))

```

# Calculate the variability
## Create a function to do this

I've rewritten that other guy's function to instead just calculate this via tibble-wrangling :)

```{r}
calc_tRMSSD <- function(mood_data, timestamp_data){
  if (length(mood_data) < 2){
    return(NA)
  } else {
  
  # create tibble and make sure it's arranged by timestamp
  data_calc <- tibble(
    mood = mood_data,
    timestamp = timestamp_data
  ) %>% 
    arrange(timestamp)
  
  # get the difference in mood and time between days
  data_calc <- data_calc %>% 
    mutate(dtime = timestamp - lag(timestamp),
           dmood = mood - lag(mood)) %>% 
    filter(!is.na(dmood)) %>% 
    mutate(dtime = as.numeric(dtime))
  
  # calculate the tRMSSD value
  sqrt(1/n*sum((data_calc$dmood/data_calc$dtime)^2))
  }
}
  
```

## Now let's do it

So this here below groups by week (a week is Mon-Sun) and participant id and then just get 


```{r}
tRMSSD_calculations <- acti_data %>% 
  group_by(week, participant_id) %>% 
  summarise(across(c(L5_onset, L5_activity, M10_onset, M10_activity, RA), ~ calc_tRMSSD(.x, timestamp))) %>% 
  rename_with(.cols = -c(week, participant_id), ~str_c("tRMSSD_", .)) %>% 
  arrange(participant_id, week)

write_csv(tRMSSD_calculations, "tRMSSD_calculation.csv")
```

# Other stuff