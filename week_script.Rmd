---
title: "Priyanka's script"
output: html_document
---

# Load libraries and read in data
```{r}
library(tidyverse) # for everything else!
library(lubridate) # for dates!
library(fs)
```

# Create function to calculate variability

I've rewritten that other guy's function to instead just calculate this via tibble-wrangling :)

```{r}
calc_tRMSSD <- function(mood_data, timestamp_data){
  if (length(mood_data) < 2){
    return(NA)
  } else {
  
  # create tibble and make sure it's arranged by timestamp
  data_calc <- tibble(
    mood = mood_data,
    timestamp = timestamp_data
  ) %>% 
    arrange(timestamp)
  
  # get the difference in mood and time between days
  data_calc <- data_calc %>% 
    mutate(dtime = timestamp - lag(timestamp),
           dmood = mood - lag(mood)) %>% 
    filter(!is.na(dmood)) %>% 
    mutate(dtime = as.numeric(dtime))
  
  # calculate the tRMSSD value
  sqrt(1/n*sum((data_calc$dmood/data_calc$dtime)^2))
  }
}
  
```

## Actigraphy data
### Read in data
```{r}
# get the csv files in a named vector
participant_data <- list.files(path = "data/raw", pattern = "actigraphy.csv$", full.names = TRUE) %>% 
  set_names()

# read them in and put in a data frame
raw_data <- map_df(participant_data, read_csv, .id = "csv_file")

# clean it up
raw_data <- raw_data %>% 
  mutate(participant_id = str_extract(path_file(csv_file), "c\\d+")) %>% 
  select(-csv_file) %>% 
  relocate(participant_id)

```

### Clean data
We are 

- adding columns for the date, week, weekday, and adds a numeric timestamp (this just as the date as a number - it's probably number of days since 1 jan 1970 or something to that effect! :)  )
- removing entries that are NA for the RA column

```{r}
acti_data <- raw_data %>% 
  mutate(date = date(calender_date),
         week = isoweek(date),
         weekday = wday(date, label = TRUE),
         date_as_number = as.numeric(date),
         date_time_as_number = as.numeric(calender_date)) %>% 
  filter(!is.na(RA))
```


So this here below groups by week (a week is Mon-Sun) and participant id and then just get 


```{r}
tRMSSD_calculations <- acti_data %>% 
  group_by(week, participant_id) %>% 
  summarise(across(c(L5_onset, L5_activity, M10_onset, M10_activity, RA), ~ calc_tRMSSD(.x, date_as_number))) %>% 
  rename_with(.cols = -c(week, participant_id), ~str_c("tRMSSD_", .)) %>% 
  arrange(participant_id, week)

write_csv(tRMSSD_calculations, "tRMSSD_calculation.csv")
```

## PANAS
### Read in data
```{r}
# get the csv files in a named vector
participant_data <- list.files(path = "data/raw", pattern = "PANAS.csv$", full.names = TRUE) %>% 
  set_names()

# read them in and put in a data frame
raw_data <- map_df(participant_data, read_csv, .id = "csv_file")

# clean it up
raw_data <- raw_data %>% 
  mutate(participant_id = str_extract(path_file(csv_file), "c\\d+")) %>% 
  select(-csv_file) %>% 
  relocate(participant_id)
```

### Clean data
We are 

- adding columns for the date, week, weekday, and adds a numeric timestamp (this just as the date as a number - it's probably number of days since 1 jan 1970 or something to that effect! :)  )
- removing entries that are NA for the RA column

```{r}
panas_data <- raw_data %>% 
  mutate(date_time = str_c(testdate, testtime, sep = " "),
         date_time = dmy_hms(date_time),
         week = isoweek(date_time),
         weekday = wday(date_time, label = TRUE),
         date_time_as_number = as.numeric(date_time))
```


So this here below groups by week (a week is Mon-Sun) and participant id and then just get 

```{r}
tRMSSD_panas <- panas_data %>% 
  group_by(week, participant_id) %>% 
  summarise(across(c(pos, neg, sum), ~ calc_tRMSSD(.x, date_time_as_number))) %>% 
  rename_with(.cols = -c(week, participant_id), ~str_c("tRMSSD_", .)) %>% 
  arrange(participant_id, week)

write_csv(tRMSSD_panas, "data/processed/tRMSSD_panas.csv")
```




# Other stuff
Here's some other stuff you wanted! :)

```{r}
# count number of weeks each participant has data from
acti_data %>% 
  distinct(participant_id, week) %>% 
  group_by(participant_id) %>% 
  summarise(num_weeks = n())

# count how many entries each participant has within a week
acti_data %>% 
  count(participant_id, week)
```

